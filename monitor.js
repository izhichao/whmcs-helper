/**
 * ä»»åŠ¡åç§°
 * name: VPS åº“å­˜ç›‘æŽ§
 * çŽ¯å¢ƒå˜é‡
 * WHMCS_URLS ç›‘æŽ§å•†å“é“¾æŽ¥ï¼ˆåŒ…å« pid çš„é“¾æŽ¥ï¼‰ å¤šä¸ªè¿žæŽ¥ç”¨è‹±æ–‡åˆ†å·ï¼ˆ;ï¼‰åˆ†å‰²
 * WHMCS_INTERVAL ç›‘æŽ§é¢‘çŽ‡ï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤ä¸ºä¸€åˆ†é’Ÿä¸€æ¬¡ï¼ˆ60000ï¼‰
 * WHMCS_LOGS æ˜¯å¦æ‰“å°è¯¦ç»†æ—¥å¿—
 * å®šæ—¶è§„åˆ™
 * cron: 0 0 1 1 *
 */

const{URL:t}=require("url"),e=require("axios"),o=require("tough-cookie"),{wrapper:n}=require("axios-cookiejar-support"),s=require("cheerio"),r="0.1.0",{sendNotify:i}=require("./sendNotify.js"),a=process.env.WHMCS_URLS||"",c=process.env.WHMCS_INTERVAL||6e4,l=process.env.WHMCS_LOGS||!0,u=a.split(";"),p={},d=new o.CookieJar,g=n(e.create({jar:d})),m=e.create({baseURL:"https://vps.tsx.us.kg"});async function h(e,o){try{const n=new t(e);0===(await d.getCookies(`${n.protocol}//${n.host}`)).length&&await g.get(e);const{data:r}=await g.get(e),a=s.load(r),c=a("body").text().trim();c.includes("ç¼ºè²¨ä¸­")||c.includes("Out of Stock")?(l&&console.log(`${S()} ç›‘æŽ§ ${o} æ— è´§`),p[e]=!0):(l&&console.log(`${S()} ç›‘æŽ§ ${o} æœ‰è´§`),p[e]&&(e.includes("bwh")||e.includes("bandwagon")?(i(...await x(a,e)),console.log((await x(a,e))[1])):e.includes("dmit")?(i(...await y(a,e)),console.log((await y(a,e))[1])):(i(...await w(a,e)),console.log((await w(a,e))[1])),p[e]=!1))}catch(t){console.error("æ£€æŸ¥åº“å­˜æ—¶å‡ºé”™:",t)}}async function w(t,e){const o=t("title").text().split("-")[1].trim(),n=t(".product-info .product-title").text(),s=t(".product-info p").eq(1).text(),r=[];t("select[name=billingcycle] option").each(((e,o)=>{r.push(t(o).text().trim())}));const i=r.join("\n");return[o+"è¡¥è´§é€šçŸ¥",await $(n,e,i,s)]}async function x(t,e){const o=t("title").text().split("-")[0].trim(),n=t(".cartbox strong").text().trim(),s=t(".cartbox strong").parent(".cartbox").html().split("<br>").map((t=>t.trim())).filter((t=>""!==t)),r=s.findIndex((t=>t.startsWith("SSD:"))),i=s.slice(r,r+5).join("\n"),a=[];t("select[name=billingcycle] option").each(((e,o)=>{a.push(t(o).text().trim())}));const c=a.join("\n");return[o+" è¡¥è´§é€šçŸ¥",await $(n,e,c,i)]}async function y(t,e){const o=t("title").text().split("-")[1].trim(),n=t(".order-summary-box .product-title").text().trim(),s=[];t(".order-summary-box .order-summary-desc-item").each(((e,o)=>{s.push(t(o).text().trim())}));const r=s.join("\n"),i=t(".summary-totals").text();return[o+"è¡¥è´§é€šçŸ¥",await $(n,e,i,r)]}async function $(t,e,o,n){const s=new URLSearchParams(e).get("pid");let r=e;try{const{data:t}=await m.post("/url",{url:e});t.url&&(r=`${t.url}&pid=${s}`)}catch{}return`\nðŸŽ åç§°\n${t}\n\nðŸ”— ä¸‹å•é“¾æŽ¥\n${r}\n\nðŸ’° ä»·æ ¼\n${o}\n\nðŸ“ å•†å“è¯¦æƒ…\n${n}\n`}function S(){const t=new Date;return`[${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}]`}console.log("è„šæœ¬æœ€æ–°åŠ¨æ€: https://t.me/whmcs_helper\n"),m.post("/stats",{urls:a,version:r}).then((t=>{console.log("å½“å‰ç‰ˆæœ¬: "+r),t.data.latest?(console.log("æœ¬è„šæœ¬å·²æ‰§è¡Œ"+t.data.count+"æ¬¡\n"),console.log("-------å¼€å§‹æ‰§è¡Œ-------"),u.forEach((async(t,e)=>{p[t]=!0,t.includes("pid")?(console.log(`[èŽ·å–åˆ° ${u.length} ä¸ªåœ°å€] å¼€å§‹ç›‘æŽ§ç¬¬ ${e+1} ä¸ªåœ°å€`),h(t,e+1),setInterval((()=>h(t,e+1)),c)):console.log("è¯·è¾“å…¥å¸¦æœ‰ pid çš„ URL åœ°å€")}))):(console.log("æœ€æ–°ç‰ˆæœ¬: "+t.data.version),console.log("è„šæœ¬å·²æ›´æ–°ï¼Œè¯·é‡æ–°æ‹‰å–è„šæœ¬ï¼"))})).catch((t=>{console.log(t)}));